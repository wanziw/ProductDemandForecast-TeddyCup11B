- 商品分层

我有一段代码，我要修改下面的代码对item_list里的商品进行商品分层，分类商品如下：

1. 新品：第36个月（date_block_num）后才开始出现的
2. 常规品：一直都在销售的，销售到了39周，且起码存在了一年以上
3. 季节性商品：存在明显的销售淡季和旺季
4. 流星品：突然出现，销售时间<5个月，然后就没什么销量了
5. 睡眠品：一直销售的挺好，再过了某个月后突然不咋销售了，并非季节性因素

```
# 分析商品，在各个地区的销售情况

for item in item_list:
    item_df = matrix[matrix["item_code"]==item]
    sales_by_region = item_df.groupby(['sales_region_code',"date_block_num"])['item_cnt_month'].sum().unstack(level=0)
    print(item)

    # 绘制折线图
    fig, ax = plt.subplots()
    sales_by_region.plot(ax=ax)
    ax.set_title(f'{item}')
#     ax.set_xlabel('time')
#     ax.set_ylabel('sale')
    plt.show()
```



- 
- 
- 最后可以画一个合成的图进行观察
- 补充特征：现在相比一年前的价格变化
- 如下分析数据，已经将部分104->105（补充分析，这些商品都是哪一类的）
- 411类型商品
  - 只有七个
  - 26-30周才出现，刚开始销量不错，后面就趋于平静。很有可能是季节性商品，只在年初销售的不错
- 401类型商品
  - 有138个
  - 一般开始销售的都较早，但是能坚持到39周的比较少
  - 有相当一部分，在35周前/左右，销量就变得很低，约等于0
  - 常年销售的一些商品，感觉是常规型商品，存在较大波动，但是无明显季节性
  - 20684、20207、20773
    - 第28月的时候，商品销售从105转移到103，同时线上转线下，整体趋势差不多
  - 好像观察到几个37-38月出现小高峰的，有好几个新品以及2019年才开始销售的
- 402类型商品
  - 有18个商品
  - 存在几个新品和几个寿命很短的商品
  - 从几个存活较长周期的商品（21819、21619）来看，是具有很强的季节性的，105地区大单子(线上)，高峰会比另外几个地区（线下）来的早那么一两个月，通常16、28为线下高峰。**这给了我们启发，通过线上销售去预判下一个月的线下销售**
- 403类型商品
  - 163个
  - 有一类：105 销售占大头，其他地区不咋销售
    - 产品趋势基本上一毛一样的20480、21977
  - 有一类：105不咋卖，就其他地区卖
    - 有其他地区的销量都差不多的（大部分）
    - 也有只有一个地区卖得好的，比如在102地区（卖得比其他地方高特别多20795、21779），26月卖得很高
  - 有一类：第15个月开始销售（有几个爆发一下就又没得了21664、21470、21804、21592、21126、21813）
  - 有一类：刚开始在104销售，第15月后就断了
  - 有一类：第28-30个月才开始销售，线上线下都销售，存在线上引领线下的现象（20384很形象），较少
  - 存在很多新品，第37个月开始销售的以及2019年才开始销售的
- 突然悟到了一点，codeid越小的，是销售越早的商品，越大的越是新品
- 404类商品
  - 线下卖，26月高峰 20555、21462、21238、20227、20414 、21095、21168、20649、21054，没办法去解释，就是销量很高，价格也没降
    - 这类还有好些第38、39月没销量的
    - 21314、21859、21738、20693  27月高峰
  -  104后面转到105的漏网之鱼？ 2018/8 101地区线下转线上，**可能是这类商品的一个特征，有待验证**
    - 20763、20768
  - 只/大部分105卖的
    - 20169、21157、20929、20868、20937、20074、20939、21835、22005
    - 80%线上 20%线下
  - 线下，2018年6月转到105的，这些如果要预测105的话就要我们多学习原先地区的特征
    - 20192、21435     101、102、103->105 同时原地区也有销售
    - 20575、21902、20047     102->105
    - 20753 101->105
    - 21398 9月105开始销售，原地区也有销售，同时线下的价格105 下降了很多
    - 20341 其他地区第30个月高峰
  - 第38个月飙升的
    - 20742、20113
  - 21242、21935 兄弟产品
  - 存在大量新品以及未销售的
- 405类商品
  - 36个商品
  - 线上
    - 20085、20911、20452、20814
  - 第16月（2017年1月）开始线下销售的
    - 20316、21088、21550、22017、20027 只线下 到第30个月差不多就没销量了
    - 20944、21986  原来有线上，突然开始线下
    - 21260、21000、20525  一直活着、102地区销量最高 20357（23月开始）
  - 三个新品
- 406类商品
  - 14个商品
  - 一个明显特征：销量比较稳定，线下销售，小额订单，2018/3 第30个月后 从105->另外三个地区
    - 20527, 20002, 20461, 21552, 20251, 20567, 21411, 21123, 20394
  - 两个新品
- 407类商品
  - 498个商品，有些销量很高，也有些生命很短的，所以推测造成误差的可能性也很高，要重点分析
  - 纯105地区
    - 20265、20139、20413、21026、21053
    - 20900、21373、21285 有年性
    - 21147、20252、21225有季节性
    - 21656、21561、21946、21984、20965  第35月噶了，不能是季节性原因应该
    - 21356、20234  第30月噶了
    - 21881、20633、21573、21735、20093 波动大，结尾猛冲
  - 纯线下
    - 20283、20368、20392、21394、21883、20501、21048、21424、21719、20172、20945、22038、20018、20221
    - 20712、20810、20973、20996、21601、20107、20766、21814、20391 波动较大
    - 21003、22048、21811、20328、20412、20424、20587、20960、21002 33月突然没咋卖了
    - 21271 量大还算稳定
  - 纯102地区
    - 20916、21942、21995、20976、21548、21602、21139、21331
    - 21455、20599、20242、21514（20周倒闭）】
    - 20918、21276、20312、20488（10周倒闭）
  - 纯103地区
    - 21256、21599 都噶了
  - 2018/3 
    - 其实不止101、103应该是其他地区都一样，只不过101、103销量相对高这样
    -  105 线上->线下  103 线下->线上，这样后续通常105销量少，103较高
      - 21562 、20568、20885、21253、21359、21212、20123、21820
      - 21546、21456 37月增
      -  
    -  105 有了线下  101 线下->线上 
      - 21913、20831、21103、22053、21237、21653
      - 20820 105销量依然高
      - 
  - 好多刚开始卖的火热，然后就慢慢没了的，有第10月突然噶了的，也有15、20、25月突然噶了的
    - 这个数量不少 ，但总是慢慢没有的，推测是销量不行就被砍掉了
    - 20月倒闭：21579、21739、21846、21869、22041、22047、20071、20045、20186、20250、20616、20425、20729、20812
    - 20月左右倒闭：20969、21043、21537、21712、20590、20220
    - 10月倒闭：21039、20802
    - 27月左右倒闭： 21853、20700、21284、21390、20794、21201、21780
  - 特殊情况
    - 21212 2018/3 105->103 2018/11 突然一个大增 预测里有四地区，但是我的模型验证集里没有？？哦哦可能是被我剔除了 
    - 20123一样 推测季节性 或双11 400+之后的有很多这样的 37、38月高峰
    - 21750、21810、21820、20925
    - 20583、20920
  - 21974居然要预测四个地区，可是31月都没啥销量
  - 20434、20892、21430、22025 小心这种28月高峰的，还有30、31月高峰，这些可能是季节性，但我也认为很有可能是新品刚出来销量高
  - 一些新品、不多
- 408类商品
- 409类商品
  - 大部分都是104、105地区销售 但不是线上 2018/8 105地区 线下->线上
    - 20740 、21296
  - 都卖
    - 20494、20697、20981、21529
  - 一些新品、不多
- 410类商品
  - 纯线下，三个地区都卖，也有只在102卖的
  - 一些新品、不多
- 412类商品



# 预处理

- 104->105的商品

  - 2017年1月份后，104地区不再销售，很多线上商品从104转移到105

  - 一个代表商品图

  - ```
     大类编码  商品数量
    0   301     10
    1   304    16
    2   307    24
    3   308    33
       小类编码  商品数量
    0   403    24
    1   404    33
    2   405     10
    3   409    16
    ```

- 403、405、404 都是2017年1月线下才开始销售
- 406 商品，线下销售，小额订单，2018年3月从105地区分到101、102、103地区，所以要预测的话，需要嫁接
- 407
  
  - 20820 突然冒出来 很诡异
  - 小高峰很多，一定是有什么规律在的。 第13个月是2016年**10月**，第25个月是2017年**10月**，第28个月是2018年1月，第30个月是2018年3月，第32个月是2018年5月，第36个月是2018年9月，第37个月是2018年**10月**。
  - 推测：
    - 春秋季商品，季度，折扣
- 408
  - 好像没啥规律
- 409
  - 大部分都是104、105地区销售 但不是线上 
  - 2018/8 105地区 线下->线上
  - 2018/5 101、102、103地区才开始卖
- 410
  - 没啥规律，有一个销量比较高的
- 411
  - 2017/11才开始销售
- 412







- 以下的表都有这些列：date_block_num	sales_region_code	item_code		first_cate_code	second_cate_code

- 其中matrix表是真实数据表，它的date_block_num从0到39，它还有一列是item_cnt_month，代表真实销量

- 其中test表是要预测的数据表，包括列sales_region_code	item_code		first_cate_code	second_cate_code

- 然后submission_40 、submission_41、submission_42三个表分别对应2019年1月、2019年2月、2019年3月份的预测数据（其余字段值都一样），它的预测销量列是item_cnt_month_pred。我现在要将这四个表合并。以test为基准，分别添加三列，对应sales_region_code、item_code的2019年1月、2019年2月、2019年3月份预测数据	

- 并且实现submission中每个商品和地区的组合可视化，可视化包括真实值和预测值

  

  

- 题目内容：附件中的训练数据（order_train1.csv）提供了国内某大型制造企业在 2015 年 9 月 1日至 2018 年 12 月 20 日面向经销商的出货数据（格式见表 1），反应了该企业产品在不同销售区域的价格和需求等信息，表df包括：order_date（订单日期）、sales_region_code（销售区域编码）、item_code（产品编码）、first_cate_code （产品大类编码）、second_cate_code （产品细类编码）、sales_chan_name （销售渠道名称）、item_price （产品价格）和 ord_qty （订单需求量）。 其中“订单日期”为某个需求量的日期；一个“产品大类编码”会对应多个“产品细类编码”；“销售渠道名称”分为 online（线上）和 offline（线下），“线上”是指淘宝和京东等电商平台，“线下”是指线下实体经销商。

- 我有一个df1，包括'sales_region_code', 'item_code', 'first_cate_code', 'secnod_cate_code','ds'(年份-月份), 'yhat'（预测销量）。df2，包括'date_block_num', 'sales_region_code', 'item_code', 'item_cnt_month'(真实值)。date_block_num是按月编号的，2015-09是第0月，2015-10是第1月，所以要先把df1的'ds'进行月编号。然后按照'date_block_num', 'sales_region_code', 'item_code', 将df2的item_cnt_month添加到df1的对应位置

- 我有一个submission_full和一个

- 根据我对销量预测的理解，分为了常规商品和新品，新品指从第一次发售到现在小于5个月的商品。我现在按照月份合成了一个表格matrix，每一行是某个月（date_block_num）的某个商品在一个地区的销量，包括date_block_num、sales_region_code、item_code、first_cate_code 、second_cate_code 、item_cnt_month（月销量）等列。

- 我在matrix中添加一列数据, 表示是否是促销月，这列上，十月、6月和1月是1，其余月份是0，提示：2015 年 9 月 1日是第0个月，

- 我在matrix中添加一列数据，对应在第38个月前每种细类商品的首次平均销量

- 我做了一列item_first_sale，表示该商品到现在销售了多少个月，我要添加一列is_brand_new，来表示这个月该商品是否为新品，如果是就是1，不是就是0。

- 我想分析节假日和销量的关系，我现在要先将数据按照线上线下分开，然后统计每一天的所有商品的销量，然后通过df["is_holiday"]=df["order_date"].map(lambda x:chinese_calendar.is_holiday(x))，标注上了这条是否是节假日的信息。分别绘制线上线下每日销量的折线图，同时在同一张图上绘制节假日的散点图

- 我要分析月初，月中，月末销量的区别，可以先给月初，月中，月末打上标签，根据标签进行分组统计，然后绘制以月份为横坐标，总销量为纵坐标，月初，月中，月末分别为三条曲线

- 我想分析双十一、618等活动对需求量的影响，比如找出收到分析双十一、618影响大的商品，该怎么做

  我做了一个按月合成的表格matrix，已经做出来了，不需要你再做，包含以下列：'date_block_num'（月份编号）, 'sales_region_code', 'item_code', 'item_cnt_month'（月销售量）, 'first_cate_code', 'second_cate_code'。

  我想给这些商品进行分类，比如新品、常规品、季节品、长尾品等等。时间序列相关性聚类是一种基于形状的聚类方法，它可以根据时间序列的变化趋势和周期性等特征来度量它们之间的相似性。这种方法通常需要使用一些专门针对时间序列的距离度量，比如动态时间规整（DTW），或者基于shapelets的方法。shapelets是一些短的时间序列片段，它们可以反映出整个时间序列的局部变化模式。

  你可以参考以下的步骤来进行时间序列相关性聚类：

  1. 对你的销售量序列进行切分，提取出不同长度或者相同长度的子序列。你可以使用滑动窗口的方法，或者基于一些分割点（比如异常值、峰值、谷值等）来划分子序列。
  2. 对每个子序列进行特征提取或者降维，以减少数据量和噪声。你可以使用统计特征（比如均值、方差、最大值、最小值等），或者使用深度学习模型（比如自编码器）来提取子序列的特征向量。
  3. 对特征向量或者原始子序列进行聚类，使用合适的距离度量和聚类算法。你可以使用DTW距离或者shapelets距离来度量子序列之间的相似性，然后使用传统的聚类算法（比如k-means或者层次聚类）来进行聚类。
  4. 对聚类结果进行评估和解释，根据不同的簇标签来给子序列进行分类，比如新品、常规品、季节品、长尾品等等。你可以使用一些内部指标（比如轮廓系数）或者外部指标（比如已知的商品分类）来评估聚类效果，也可以使用可视化方法来展示不同簇之间的差异和相似性。

  

  

  1. 线上线下特征问题

  我现在要在matrix中增加一个特征'date_item_chan_class'，该特征是根据matrix中的一行（date_block_num、item_code、sales_region_code）来定位，值是上一个月（date_block_num-1）的销售渠道大部分是online或者offline，如果是online该列就赋值为0，否则为1

  ```python
  import pandas as pd
  
  # 读取数据，生成matrix表格
  order_data = pd.read_csv('order_train1.csv')
  matrix = order_data.groupby(['date_block_num', 'sales_region_code', 'item_code', 'first_cate_code', 'second_cate_code'], as_index=False)\
      .agg({'ord_qty': 'sum', 'item_price': 'mean'})\
      .rename(columns={'ord_qty': 'item_cnt_month'})
      
  # 将item_cnt_month列向下移动一个月
  matrix['item_cnt_prev_month'] = matrix.groupby(['sales_region_code', 'item_code'])['item_cnt_month'].shift(1)
  
  # 计算上一个月online销售量和offline销售量的比例
  matrix['online_ratio'] = matrix.apply(lambda x: x['item_cnt_prev_month'] if x['item_cnt_prev_month'] > 0 and x['sales_chan_name'] == 'online' else 0, axis=1)
  matrix['offline_ratio'] = matrix.apply(lambda x: x['item_cnt_prev_month'] if x['item_cnt_prev_month'] > 0 and x['sales_chan_name'] == 'offline' else 0, axis=1)
  matrix['online_ratio'] = matrix.groupby(['date_block_num', 'sales_region_code', 'item_code'])['online_ratio'].transform('sum')
  matrix['offline_ratio'] = matrix.groupby(['date_block_num', 'sales_region_code', 'item_code'])['offline_ratio'].transform('sum')
  matrix['total_ratio'] = matrix['online_ratio'] + matrix['offline_ratio']
  matrix['online_ratio'] = matrix['online_ratio'] / matrix['total_ratio']
  matrix['offline_ratio'] = matrix['offline_ratio'] / matrix['total_ratio']
  
  # 判断上一个月销售渠道的主要类型，赋值给'date_item_chan_class'列
  matrix['date_item_chan_class'] = matrix.apply(lambda x: 0 if x['online_ratio'] >= 0.5 else 1, axis=1)
  
  # 删除不需要的列
  matrix.drop(['item_cnt_prev_month', 'online_ratio', 'offline_ratio', 'total_ratio'], axis=1, inplace=True)
  
  ```




这一段目前是计算了双十一和618期间的销售，而我现在变了，我只要计算双十一，而且要区分开11.1到11.11区间和非这个区间的两个group

```
        # 计算该组合在双十一、618期间和非活动期间的平均销量
        mean_qty_promotion = group[(group['order_date'].dt.month == 11) | (group['order_date'].dt.month == 6)]['ord_qty'].mean()
        mean_qty_non_promotion = group[(group['order_date'].dt.month != 11) & (group['order_date'].dt.month != 6)]['ord_qty'].mean()

```

```
20687 105
 21606 103
 21105 105
 20392 105
 21224 103
 21801 102
 20567 101
```

